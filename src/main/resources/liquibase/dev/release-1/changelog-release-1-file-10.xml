<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">


    <changeSet id="calc-rus-308" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>rename column calc_daily_sheet_headers</comment>
        <renameColumn columnDataType="varchar2(20)"
                      newColumnName="data_status"
                      oldColumnName="status"
                      remarks="Статус данных"
                      schemaName="apps"
                      tableName="calc_daily_sheet_headers"/>
    </changeSet>

    <changeSet id="calc-rus-309" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>modify datatype column calc_daily_sheet_headers</comment>
        <modifyDataType columnName="data_status"
                        newDataType="varchar2(20)"
                        schemaName="apps"
                        tableName="calc_daily_sheet_headers"/>
    </changeSet>

    <changeSet id="calc-rus-310" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_daily_sheet_headers to calc_data_statuses</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_daily_sheet_headers"
                baseColumnNames="data_status"
                constraintName="fk_calc_daily_sheet_headers_4"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="calc_data_statuses"
                referencedColumnNames="code"
        />
    </changeSet>

    <changeSet id="calc-rus-311" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_daily_sheet_headers.data_status</comment>
        <dropNotNullConstraint columnDataType="varchar2(10)"
                               columnName="data_status"
                               schemaName="apps"
                               tableName="calc_daily_sheet_headers"/>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-312" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_asp1_lines_tl.name</comment>
        <dropNotNullConstraint columnDataType="varchar2(500)"
                               columnName="name"
                               schemaName="apps"
                               tableName="calc_asp1_lines_tl"/>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-313" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>change default value calc_formula_var_det</comment>
        <addDefaultValue columnDataType="varchar2"
                         columnName="param_type"
                         defaultValue="PT"
                         schemaName="apps"
                         tableName="calc_formula_var_det"/>
    </changeSet>

    <changeSet id="calc-rus-314" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop column calc_signatories</comment>
        <dropColumn columnName="doc_type_id"
                    schemaName="apps"
                    tableName="calc_balance_units"/>
    </changeSet>

    <changeSet id="calc-rus-315" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>add column calc_signatories</comment>
        <addColumn schemaName="apps"
                   tableName="calc_balance_units">
            <column name="doc_type" type="varchar2(30)"/>
        </addColumn>
    </changeSet>

    <changeSet id="calc-rus-316" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_balance_units to dm_regulations</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_balance_units"
                baseColumnNames="doc_type"
                constraintName="fk_calc_balance_units_4"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="dm_regulations"
                referencedColumnNames="code"
        />
    </changeSet>

    <changeSet id="calc-rus-317" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating table: calc_bs_result_bp_lines</comment>
        <createTable tableName="calc_bs_result_bp_lines" schemaName="apps" remarks="Режимы работы обходных выключателей">
            <column name="id" type="number" remarks="Идентификатор">
                <constraints nullable="false"/>
            </column>

            <column name="bs_result_header_id" type="number" remarks="Идентификатор заголовка расчёта">
                <constraints nullable="false"/>
            </column>

            <column name="bypass_metering_point_id" type="number" remarks="ID обходного счетчика">
                <constraints nullable="false"/>
            </column>

            <column name="is_bus_section" type="number" remarks="Включен между секциями шин">
                <constraints nullable="true"/>
            </column>

            <column name="metering_point_id" type="number" remarks="ID точки учета на которую работал">
                <constraints nullable="true"/>
            </column>

            <column name="param_id" type="number" remarks="ID параметра измерений">
                <constraints nullable="false"/>
            </column>

            <column name="meter_id" type="number" remarks="ID счётчика на обходном выключателе">
                <constraints nullable="false"/>
            </column>

            <column name="start_metering_date" type="TIMESTAMP" remarks="Дата и время начальных показаний">
                <constraints nullable="false"/>
            </column>

            <column name="end_metering_date" type="TIMESTAMP" remarks="Дата и время конечных показаний">
                <constraints nullable="false"/>
            </column>

            <column name="start_val" type="number" remarks="Начальные показания счетчика">
                <constraints nullable="true"/>
            </column>

            <column name="end_val" type="number" remarks="Конечные показания счетчика">
                <constraints nullable="true"/>
            </column>

            <column name="delta" type="number" remarks="Разность показаний">
                <constraints nullable="true"/>
            </column>

            <column name="meter_rate" type="number" remarks="Коэффициент счетчика">
                <constraints nullable="true"/>
            </column>

            <column name="val" type="number" remarks="Расход электроэнергии за период">
                <constraints nullable="true"/>
            </column>

            <column name="unit_id" type="number" remarks="Единица измерения">
                <constraints nullable="false"/>
            </column>

            <column name="bypass_turn_on_time" type="TIMESTAMP" remarks="Дата и время включения обходного выключателя">
                <constraints nullable="true"/>
            </column>

            <column name="bypass_turn_off_time" type="TIMESTAMP" remarks="Дата и время отключения обходного выключателя">
                <constraints nullable="true"/>
            </column>

            <column name="create_date" type="TIMESTAMP" remarks="Дата создания">
                <constraints nullable="true"/>
            </column>

            <column name="last_update_date" type="TIMESTAMP" remarks="Дата обновления">
                <constraints nullable="true"/>
            </column>

            <column name="create_by" type="number" remarks="Автор">
                <constraints nullable="true"/>
            </column>

            <column name="last_update_by" type="number" remarks="Автор обновления">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="calc-rus-318" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating primary key for table: calc_bs_result_bp_lines</comment>
        <addPrimaryKey
                columnNames="id"
                constraintName="pk_calc_bs_result_bp_lines"
                schemaName="apps"
                tableName="calc_bs_result_bp_lines"/>
    </changeSet>

    <changeSet id="calc-rus-319" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating index: calc_bs_result_bp_lines</comment>
        <createIndex indexName="idx_calc_bs_result_bp_lines_n1"
                     schemaName="apps"
                     tableName="calc_bs_result_bp_lines"
                     unique="false">
            <column name="bs_result_header_id" type="number"/>
            <column name="bypass_metering_point_id" type="number"/>
        </createIndex>
    </changeSet>

    <changeSet id="calc-rus-320" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating index: calc_bs_result_bp_lines</comment>
        <createIndex indexName="idx_calc_bs_result_bp_lines_n2"
                     schemaName="apps"
                     tableName="calc_bs_result_bp_lines"
                     unique="false">
            <column name="param_id" type="number"/>
        </createIndex>
    </changeSet>

    <changeSet id="calc-rus-321" logicalFilePath="path-independent" author="eugene" context="dev">
        <comment>Creating index: calc_bs_result_bp_lines</comment>
        <createIndex indexName="idx_calc_bs_result_bp_lines_n3"
                     schemaName="apps"
                     tableName="calc_bs_result_bp_lines"
                     unique="false">
            <column name="unit_id" type="number"/>
        </createIndex>
    </changeSet>

    <changeSet id="calc-rus-322" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_bs_result_bp_lines to calc_bs_result_headers</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_bs_result_bp_lines"
                baseColumnNames="bs_result_header_id"
                constraintName="fk_calc_bs_result_bp_lines_1"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="calc_bs_result_headers"
                referencedColumnNames="id"
        />
    </changeSet>

    <changeSet id="calc-rus-323" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_bs_result_bp_lines to dict_metering_points</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_bs_result_bp_lines"
                baseColumnNames="metering_point_id"
                constraintName="fk_calc_bs_result_bp_lines_2"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="dict_metering_points"
                referencedColumnNames="id"
        />
    </changeSet>

    <changeSet id="calc-rus-324" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_bs_result_bp_lines to dict_metering_points</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_bs_result_bp_lines"
                baseColumnNames="bypass_metering_point_id"
                constraintName="fk_calc_bs_result_bp_lines_3"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="dict_metering_points"
                referencedColumnNames="id"
        />
    </changeSet>

    <changeSet id="calc-rus-325" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_bs_result_bp_lines to media_parameters</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_bs_result_bp_lines"
                baseColumnNames="param_id"
                constraintName="fk_calc_bs_result_bp_lines_4"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="media_parameters"
                referencedColumnNames="id"
        />
    </changeSet>

    <changeSet id="calc-rus-326" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_bs_result_bp_lines to mdfem_eem_base</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_bs_result_bp_lines"
                baseColumnNames="meter_id"
                constraintName="fk_calc_bs_result_bp_lines_5"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="mdfem_eem_base"
                referencedColumnNames="id"
        />
    </changeSet>

    <changeSet id="calc-rus-327" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_bs_result_bp_lines to dict_units</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_bs_result_bp_lines"
                baseColumnNames="param_id"
                constraintName="fk_calc_bs_result_bp_lines_6"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="dict_units"
                referencedColumnNames="id"
        />
    </changeSet>

    <changeSet id="calc-rus-328" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Add comments to the columns CALC_DAILY_SHEET_LINES</comment>
        <sql dbms="postgres, oracle" endDelimiter=";" splitStatements="true" stripComments="true">
            update apps.calc_data_statuses_tl
            set name = 'Корректно'
            where code = 'OK';
        </sql>
    </changeSet>

    <changeSet id="calc-rus-329" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Add comments to the columns CALC_DAILY_SHEET_LINES</comment>
        <sql dbms="postgres, oracle" endDelimiter=";" splitStatements="true" stripComments="true">
            update apps.calc_activation_types_tl
            set name = 'Активирован'
            where code = 'ACTIVATE';
        </sql>
    </changeSet>

    <changeSet id="calc-rus-330" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Add comments to the columns CALC_DAILY_SHEET_LINES</comment>
        <sql dbms="postgres, oracle" endDelimiter=";" splitStatements="true" stripComments="true">
            update apps.calc_activation_types_tl
            set name = 'Деактивирован'
            where code = 'DEACTIVATE';
        </sql>
    </changeSet>


    <changeSet id="calc-rus-331" logicalFilePath="path-independent" author="eugene" context="dev">
        <comment>Adding data to table: calc_balance_types</comment>
        <insert tableName="calc_activation_types" schemaName="apps">
            <column name="code" value="PUBLISH" />
        </insert>

        <insert tableName="calc_activation_types" schemaName="apps">
            <column name="code" value="UNPUBLISH" />
        </insert>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-332" logicalFilePath="path-independent" author="eugene" context="dev">
        <comment>Adding data to table: calc_activation_types_tl</comment>
        <insert tableName="calc_activation_types_tl" schemaName="apps">
            <column name="code" value="PUBLISH" />
            <column name="lang" value="RU" />
            <column name="name" value="Опубликован" />
        </insert>

        <insert tableName="calc_activation_types_tl" schemaName="apps">
            <column name="code" value="UNPUBLISH" />
            <column name="lang" value="RU" />
            <column name="name" value="Отменен доступ" />
        </insert>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-333" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop foreign constraint: calc_metering_data_sources_tl to calc_metering_data_sources_tl</comment>
        <dropForeignKeyConstraint baseTableName="calc_service_values_reconciliations" constraintName="fk_calc_service_values_reconciliations_5" baseTableSchemaName="apps"/>
    </changeSet>

    <changeSet id="calc-rus-334" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_bs_result_bp_lines to dict_units</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_service_values_reconciliations"
                baseColumnNames="status"
                constraintName="fk_calc_service_values_reconciliations_5"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="media_batch_statuses"
                referencedColumnNames="code"
        />
    </changeSet>

    <changeSet id="calc-rus-335" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>add column calc_service_values_reconciliations_l</comment>
        <addColumn schemaName="apps"
                   tableName="calc_service_values_reconciliations_l">
            <column name="is_total" type="number" remarks="итого по договору"/>
        </addColumn>
    </changeSet>

    <changeSet id="calc-rus-336" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_service_values_reconciliations_l</comment>
        <dropNotNullConstraint columnDataType="number"
                               columnName="create_by"
                               schemaName="apps"
                               tableName="calc_service_values_reconciliations_l"/>
        <rollback/>
    </changeSet>


    <changeSet id="calc-rus-337" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_service_values_reconciliations_l</comment>
        <dropNotNullConstraint columnDataType="TIMESTAMP"
                               columnName="create_date"
                               schemaName="apps"
                               tableName="calc_service_values_reconciliations_l"/>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-338" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_service_values_reconciliations_l</comment>
        <dropNotNullConstraint columnDataType="number"
                               columnName="last_update_by"
                               schemaName="apps"
                               tableName="calc_service_values_reconciliations_l"/>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-339" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_service_values_reconciliations_l</comment>
        <dropNotNullConstraint columnDataType="TIMESTAMP"
                               columnName="last_update_date"
                               schemaName="apps"
                               tableName="calc_service_values_reconciliations_l"/>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-340" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_service_values_reconciliations</comment>
        <dropNotNullConstraint columnDataType="number"
                               columnName="create_by"
                               schemaName="apps"
                               tableName="calc_service_values_reconciliations"/>
        <rollback/>
    </changeSet>


    <changeSet id="calc-rus-341" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_service_values_reconciliations</comment>
        <dropNotNullConstraint columnDataType="TIMESTAMP"
                               columnName="create_date"
                               schemaName="apps"
                               tableName="calc_service_values_reconciliations"/>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-342" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_service_values_reconciliations</comment>
        <dropNotNullConstraint columnDataType="number"
                               columnName="last_update_by"
                               schemaName="apps"
                               tableName="calc_service_values_reconciliations"/>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-343" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_service_values_reconciliations</comment>
        <dropNotNullConstraint columnDataType="TIMESTAMP"
                               columnName="last_update_date"
                               schemaName="apps"
                               tableName="calc_service_values_reconciliations"/>
        <rollback/>
    </changeSet>


    <changeSet id="calc-rus-336" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_service_values_reconciliations_l</comment>
        <dropNotNullConstraint columnDataType="number"
                               columnName="create_by"
                               schemaName="apps"
                               tableName="calc_service_values_reconciliations_l"/>
        <rollback/>
    </changeSet>
</databaseChangeLog>

