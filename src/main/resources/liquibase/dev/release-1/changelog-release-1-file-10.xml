<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">


    <changeSet id="calc-rus-308" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>rename column calc_daily_sheet_headers</comment>
        <renameColumn columnDataType="varchar2(20)"
                      newColumnName="data_status"
                      oldColumnName="status"
                      remarks="Статус данных"
                      schemaName="apps"
                      tableName="calc_daily_sheet_headers"/>
    </changeSet>

    <changeSet id="calc-rus-309" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>modify datatype column calc_daily_sheet_headers</comment>
        <modifyDataType columnName="data_status"
                        newDataType="varchar2(20)"
                        schemaName="apps"
                        tableName="calc_daily_sheet_headers"/>
    </changeSet>

    <changeSet id="calc-rus-310" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_daily_sheet_headers to calc_data_statuses</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_daily_sheet_headers"
                baseColumnNames="data_status"
                constraintName="fk_calc_daily_sheet_headers_4"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="calc_data_statuses"
                referencedColumnNames="code"
        />
    </changeSet>

    <changeSet id="calc-rus-311" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_daily_sheet_headers.data_status</comment>
        <dropNotNullConstraint columnDataType="varchar2(10)"
                               columnName="data_status"
                               schemaName="apps"
                               tableName="calc_daily_sheet_headers"/>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-312" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop not null constraint calc_asp1_lines_tl.name</comment>
        <dropNotNullConstraint columnDataType="varchar2(500)"
                               columnName="name"
                               schemaName="apps"
                               tableName="calc_asp1_lines_tl"/>
        <rollback/>
    </changeSet>

    <changeSet id="calc-rus-313" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>change default value calc_formula_var_det</comment>
        <addDefaultValue columnDataType="varchar2"
                         columnName="param_type"
                         defaultValue="PT"
                         schemaName="apps"
                         tableName="calc_formula_var_det"/>
    </changeSet>

    <changeSet id="calc-rus-314" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>drop column calc_signatories</comment>
        <dropColumn columnName="doc_type_id"
                    schemaName="apps"
                    tableName="calc_balance_units"/>
    </changeSet>

    <changeSet id="calc-rus-315" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>add column calc_signatories</comment>
        <addColumn schemaName="apps"
                   tableName="calc_balance_units">
            <column name="doc_type" type="varchar2(30)"/>
        </addColumn>
    </changeSet>

    <changeSet id="calc-rus-316" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating foreign constraint: calc_balance_units to dm_regulations</comment>
        <addForeignKeyConstraint
                baseTableSchemaName="apps"
                baseTableName="calc_balance_units"
                baseColumnNames="doc_type"
                constraintName="fk_calc_balance_units_4"
                deferrable="true"
                initiallyDeferred="true"
                onDelete="RESTRICT"
                onUpdate="RESTRICT"
                referencedTableSchemaName="apps"
                referencedTableName="dm_regulations"
                referencedColumnNames="code"
        />
    </changeSet>

    <changeSet id="calc-rus-317" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating table: calc_bs_result_bp_lines</comment>
        <createTable tableName="calc_bs_result_bp_lines" schemaName="apps" remarks="Режимы работы обходных выключателей">
            <column name="id" type="number" remarks="Идентификатор">
                <constraints nullable="false"/>
            </column>

            <column name="bs_result_header_id" type="number" remarks="Идентификатор заголовка расчёта">
                <constraints nullable="false"/>
            </column>

            <column name="bypass_metering_point_id" type="number" remarks="ID обходного счетчика">
                <constraints nullable="false"/>
            </column>

            <column name="is_bus_section" type="number" remarks="Включен между секциями шин">
                <constraints nullable="true"/>
            </column>

            <column name="metering_point_id" type="number" remarks="ID точки учета на которую работал">
                <constraints nullable="true"/>
            </column>

            <column name="param_id" type="number" remarks="ID параметра измерений">
                <constraints nullable="false"/>
            </column>

            <column name="meter_id" type="number" remarks="ID счётчика на обходном выключателе">
                <constraints nullable="false"/>
            </column>

            <column name="start_metering_date" type="TIMESTAMP" remarks="Дата и время начальных показаний">
                <constraints nullable="false"/>
            </column>

            <column name="end_metering_date" type="TIMESTAMP" remarks="Дата и время конечных показаний">
                <constraints nullable="false"/>
            </column>

            <column name="start_val" type="number" remarks="Начальные показания счетчика">
                <constraints nullable="true"/>
            </column>

            <column name="end_val" type="number" remarks="Конечные показания счетчика">
                <constraints nullable="true"/>
            </column>

            <column name="delta" type="number" remarks="Разность показаний">
                <constraints nullable="true"/>
            </column>

            <column name="meter_rate" type="number" remarks="Коэффициент счетчика">
                <constraints nullable="true"/>
            </column>

            <column name="val" type="number" remarks="Расход электроэнергии за период">
                <constraints nullable="true"/>
            </column>

            <column name="unit_id" type="number" remarks="Единица измерения">
                <constraints nullable="false"/>
            </column>

            <column name="bypass_turn_on_time" type="TIMESTAMP" remarks="Дата и время включения обходного выключателя">
                <constraints nullable="true"/>
            </column>

            <column name="bypass_turn_off_time" type="TIMESTAMP" remarks="Дата и время отключения обходного выключателя">
                <constraints nullable="true"/>
            </column>

            <column name="create_date" type="TIMESTAMP" remarks="Дата создания">
                <constraints nullable="true"/>
            </column>

            <column name="last_update_date" type="TIMESTAMP" remarks="Дата обновления">
                <constraints nullable="true"/>
            </column>

            <column name="create_by" type="number" remarks="Автор">
                <constraints nullable="true"/>
            </column>

            <column name="last_update_by" type="number" remarks="Автор обновления">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="calc-rus-318" logicalFilePath="path-independent" author="ruslan" context="dev">
        <comment>Creating primary key for table: calc_bs_result_bp_lines</comment>
        <addPrimaryKey
                columnNames="id"
                constraintName="pk_calc_bs_result_bp_lines"
                schemaName="apps"
                tableName="calc_bs_result_bp_lines"/>
    </changeSet>
</databaseChangeLog>
